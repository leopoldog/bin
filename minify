#!/bin/bash

. $(dirname "$0")/library.sh

if ! checkDependencies wmctrl xwininfo
then
  exit -1
fi

LABEL="$1"

if [ -z "$LABEL" ]
then
  echo "Usage: $(basename "$0") <label> [command]"
  exit -1
fi

exec > /tmp/minify.log 2>&1

shift 1

"$@"

LC_ALL=C

echo "$LABEL"

i=0
while true
do
  echo "Try: $i - $(date +"%H:%M:%S")"
  ID=$(${WMCTRL} -l | grep -i "$LABEL" | cut -d" " -f1)

  if [ ! -z "$ID" ]
  then
    STATE=$(${XWININFO} -id $ID 2>&1)
    echo "$LABEL - $STATE"

    if echo "$STATE" | grep -q "Map State: IsUnMapped"
    then
      echo "Unmapped"
      break
    fi

    if ${WMCTRL} -c "$LABEL"
    then
      echo "Success"
      break
    fi
  fi

  let i=i+1

  if [ $i -ge 240 ] # 1 minute
  then
    echo "Timeout"
    break
  else
    echo "Wait 0.25"
    sleep 0.25
  fi
done
